---
summary: "模型故障转移机制"
read_when:
  - 你想了解认证配置文件如何轮换
  - 你需要配置模型回退
  - 你在调试认证失败问题
---

# 模型故障转移

## 概述

OpenClaw 通过两阶段过程管理故障：首先在提供者内部轮换认证配置文件，然后回退到 `agents.defaults.model.fallbacks` 中配置的替代模型。

## 认证存储

系统使用**认证配置文件**存储 API 密钥和 OAuth 令牌。密钥存储在 `~/.openclaw/agents/<agentId>/agent/auth-profiles.json`。`auth.profiles` 和 `auth.order` 的配置条目处理"仅元数据 + 路由"，不包含密钥。

存在两种凭据类型：
- **API 密钥类型**：包含提供者和密钥
- **OAuth 类型**：包含提供者、访问/刷新令牌、过期时间和可选电子邮件

## 配置文件 ID

OAuth 登录生成不同的配置文件，允许多个账户。默认格式是 `provider:default`（无电子邮件时）或 `provider:<email>`（有电子邮件时）。

## 轮换顺序

配置文件选择遵循以下优先级：
1. 通过 `auth.order[provider]` 的显式配置
2. 按提供者过滤的已配置配置文件
3. 来自 auth-profiles 文件的存储配置文件

没有显式排序时，轮询选择优先 OAuth 而非 API 密钥，然后按最旧的 `lastUsed` 时间戳排序。冷却中的配置文件移到末尾。

## 会话粘性

OpenClaw"为每个会话固定选择的认证配置文件"以提高缓存效率。固定在会话重置、压缩完成或配置文件进入冷却时重置。用户固定的配置文件保持锁定；如果失败，系统移动到模型回退而不是切换配置文件。

## 冷却

失败的配置文件进入指数退避冷却：1 分钟 → 5 分钟 → 25 分钟 → 1 小时上限。状态跟踪包括 `lastUsed`、`cooldownUntil` 和 `errorCount` 字段。

## 计费禁用

信用/计费失败触发更长的禁用而非短冷却。退避从 5 小时开始，每次失败翻倍，上限为 24 小时。计数器在 24 小时无失败后重置。

## 模型回退

当所有提供者配置文件失败时，系统前进到回退列表中的下一个模型。这适用于认证失败、速率限制和耗尽的配置文件轮换超时。

## 相关配置

关键设置包括 `auth.profiles`、`auth.order`、各种冷却参数，以及 Gateway 配置中的模型主/回退定义。
