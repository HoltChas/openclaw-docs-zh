<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流式传输 - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">

            <div class="nav-section">
                <span class="nav-section-title">入门指南</span>
                <a href="../start/getting-started.html">快速入门</a>
                <a href="../start/wizard.html">向导</a>
                <a href="../start/pairing.html">配对</a>
                <a href="../start/setup.html">设置</a>
                <a href="../start/openclaw.html">OpenClaw 助手</a>
                <a href="../start/hubs.html">文档中心</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">网关配置</span>
                <a href="../gateway/configuration.html">配置</a>
                <a href="../gateway/configuration-examples.html">配置示例</a>
                <a href="../gateway/security.html">安全</a>
                <a href="../gateway/remote.html">远程访问</a>
                <a href="../gateway/tailscale.html">Tailscale</a>
                <a href="../gateway/multiple-gateways.html">多网关</a>
                <a href="../gateway/discovery.html">发现机制</a>
                <a href="../environment.html">环境变量</a>
                <a href="../logging.html">日志配置</a>
                <a href="../network.html">网络配置</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">消息渠道</span>
                <a href="../channels/whatsapp.html">WhatsApp</a>
                <a href="../channels/telegram.html">Telegram</a>
                <a href="../channels/discord.html">Discord</a>
                <a href="../channels/mattermost.html">Mattermost</a>
                <a href="../channels/imessage.html">iMessage</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">Web 界面</span>
                <a href="../web/webchat.html">WebChat</a>
                <a href="../web/control-ui.html">控制界面</a>
                <a href="../web/dashboard.html">控制台</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">核心概念</span>
                <a href="../concepts/streaming.html">流式传输</a>
                <a href="../concepts/groups.html">群组</a>
                <a href="../concepts/group-messages.html">群组消息</a>
                <a href="../concepts/multi-agent.html">多代理路由</a>
                <a href="../concepts/session.html">会话</a>
                <a href="../broadcast-groups.html">广播群组</a>
                <a href="../multi-agent-sandbox-tools.html">多代理沙盒</a>
                <a href="../date-time.html">日期时间</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">自动化</span>
                <a href="../automation/cron-jobs.html">定时任务</a>
                <a href="../automation/webhook.html">Webhooks</a>
                <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                <a href="../hooks.html">钩子系统</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">工具与技能</span>
                <a href="../tools/slash-commands.html">斜杠命令</a>
                <a href="../tools/skills.html">技能</a>
                <a href="../tools/skills-config.html">技能配置</a>
                <a href="../tools/web.html">Web 工具</a>
                <a href="../brave-search.html">Brave 搜索</a>
                <a href="../perplexity.html">Perplexity</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">安装与平台</span>
                <a href="../install/updating.html">更新</a>
                <a href="../install/nix.html">Nix 模式</a>
                <a href="../platforms/macos.html">macOS</a>
                <a href="../platforms/ios.html">iOS</a>
                <a href="../platforms/android.html">Android</a>
                <a href="../platforms/windows.html">Windows (WSL2)</a>
                <a href="../platforms/linux.html">Linux</a>
                <a href="../northflank.html">Northflank 部署</a>
                <a href="../bedrock.html">AWS Bedrock</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">节点与媒体</span>
                <a href="../nodes/index.html">节点</a>
                <a href="../nodes/images.html">图片</a>
                <a href="../nodes/audio.html">音频</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">CLI 与调试</span>
                <a href="../cli/index.html">CLI 参考</a>
                <a href="../debug/node-issue.html">Node 问题</a>
                <a href="../diagnostics/flags.html">诊断标志</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">实验性</span>
                <a href="../experiments/onboarding-config-protocol.html">配置协议</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">其他</span>
                <a href="../help.html">帮助</a>
            </div>

            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>流式传输</h1>
<h1>流式传输 + 分块</h1>
<p>OpenClaw 有两个独立的&quot;流式传输&quot;层：</p>
<ul>
<li><strong>块流式传输（频道）：</strong> 在助手写入时发出完成的<strong>块</strong>。这些是普通频道消息（不是 token delta）。</li>
<li><strong>类 token 流式传输（仅限 Telegram）：</strong> 在生成时用部分文本更新<strong>草稿气泡</strong>；最终消息在末尾发送。</li>
</ul>
<p>今天<strong>没有真正的 token 流式传输</strong>到外部频道消息。Telegram 草稿流式传输是唯一的部分流表面。</p>
<h2>块流式传输（频道消息）</h2>
<p>块流式传输在助手输出可用时以粗粒度块发送。</p>
<pre><code>模型输出
  └─ text_delta/事件
       ├─ (blockStreamingBreak=text_end)
       │    └─ 分块器在缓冲区增长时发出块
       └─ (blockStreamingBreak=message_end)
            └─ 分块器在 message_end 时刷新
                   └─ 频道发送（块回复）
</code></pre>
<p>图例：</p>
<ul>
<li><code>text_delta/事件</code>：模型流事件（对于非流式模型可能稀疏）。</li>
<li><code>分块器</code>：<code>EmbeddedBlockChunker</code> 应用最小/最大边界 + 中断偏好。</li>
<li><code>频道发送</code>：实际出站消息（块回复）。</li>
</ul>
<p><strong>控制：</strong></p>
<ul>
<li><code>agents.defaults.blockStreamingDefault</code>：<code>&quot;on&quot;</code>/<code>&quot;off&quot;</code>（默认关闭）。</li>
<li>频道覆盖：<code>*.blockStreaming</code>（和每账户变体）以强制每频道 <code>&quot;on&quot;</code>/<code>&quot;off&quot;</code>。</li>
<li><code>agents.defaults.blockStreamingBreak</code>：<code>&quot;text_end&quot;</code> 或 <code>&quot;message_end&quot;</code>。</li>
<li><code>agents.defaults.blockStreamingChunk</code>：<code>{ minChars, maxChars, breakPreference? }</code>。</li>
<li><code>agents.defaults.blockStreamingCoalesce</code>：<code>{ minChars?, maxChars?, idleMs? }</code>（发送前合并流式块）。</li>
<li>频道硬上限：<code>*.textChunkLimit</code>（例如 <code>channels.whatsapp.textChunkLimit</code>）。</li>
<li>频道分块模式：<code>*.chunkMode</code>（默认 <code>length</code>，<code>newline</code> 在长度分块前按空行（段落边界）分割）。</li>
<li>Discord 软上限：<code>channels.discord.maxLinesPerMessage</code>（默认 17）分割高回复以避免 UI 裁剪。</li>
</ul>
<p><strong>边界语义：</strong></p>
<ul>
<li><code>text_end</code>：分块器发出时立即流式传输块；在每个 <code>text_end</code> 时刷新。</li>
<li><code>message_end</code>：等待助手消息完成，然后刷新缓冲的输出。</li>
</ul>
<p>如果缓冲的文本超过 <code>maxChars</code>，<code>message_end</code> 仍然使用分块器，因此它可以在末尾发出多个块。</p>
<h2>分块算法（低/高边界）</h2>
<p>块分块由 <code>EmbeddedBlockChunker</code> 实现：</p>
<ul>
<li><strong>低边界：</strong> 缓冲区 &gt;= <code>minChars</code> 之前不发出（除非强制）。</li>
<li><strong>高边界：</strong> 优先在 <code>maxChars</code> 之前分割；如果强制，在 <code>maxChars</code> 处分割。</li>
<li><strong>中断偏好：</strong> <code>paragraph</code> → <code>newline</code> → <code>sentence</code> → <code>whitespace</code> → 硬中断。</li>
<li><strong>代码围栏：</strong> 永不在围栏内分割；当在 <code>maxChars</code> 处强制时，关闭 + 重新打开围栏以保持 Markdown 有效。</li>
</ul>
<p><code>maxChars</code> 被限制到频道 <code>textChunkLimit</code>，因此你不能超过每频道上限。</p>
<h2>合并（合并流式块）</h2>
<p>启用块流式传输时，OpenClaw 可以<strong>在发送前合并连续的块块</strong>。<br>这减少了&quot;单行垃圾邮件&quot;，同时仍然提供渐进输出。</p>
<ul>
<li>合并在刷新前等待<strong>空闲间隙</strong>（<code>idleMs</code>）。</li>
<li>缓冲区由 <code>maxChars</code> 限制，如果超过将刷新。</li>
<li><code>minChars</code> 防止微小片段发送，直到累积足够的文本<br>（最终刷新总是发送剩余文本）。</li>
<li>连接符派生自 <code>blockStreamingChunk.breakPreference</code><br>（<code>paragraph</code> → <code>\n\n</code>，<code>newline</code> → <code>\n</code>，<code>sentence</code> → 空格）。</li>
<li>频道覆盖通过 <code>*.blockStreamingCoalesce</code> 可用（包括每账户配置）。</li>
<li>默认合并 <code>minChars</code> 对于 Signal/Slack/Discord 增加到 1500，除非覆盖。</li>
</ul>
<h2>块之间的人性化节奏</h2>
<p>启用块流式传输时，你可以在块回复之间添加<strong>随机暂停</strong>（在第一块之后）。这使多气泡响应感觉更自然。</p>

        </div>
    </main>

    <script src="../assets/js/main.js"></script>
</body>
</html>
