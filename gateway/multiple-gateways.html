<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多网关 - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css?v=3">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">

            <div class="nav-section">
                <span class="nav-section-title">入门指南</span>
                <a href="../start/getting-started.html">快速入门</a>
                <a href="../start/wizard.html">向导</a>
                <a href="../start/pairing.html">配对</a>
                <a href="../start/setup.html">设置</a>
                <a href="../start/openclaw.html">OpenClaw 助手</a>
                <a href="../start/hubs.html">文档中心</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">网关配置</span>
                <a href="../gateway/configuration.html">配置</a>
                <a href="../gateway/configuration-examples.html">配置示例</a>
                <a href="../gateway/security.html">安全</a>
                <a href="../gateway/remote.html">远程访问</a>
                <a href="../gateway/tailscale.html">Tailscale</a>
                <a href="../gateway/multiple-gateways.html">多网关</a>
                <a href="../gateway/discovery.html">发现机制</a>
                <a href="../environment.html">环境变量</a>
                <a href="../logging.html">日志配置</a>
                <a href="../network.html">网络配置</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">消息渠道</span>
                <a href="../channels/whatsapp.html">WhatsApp</a>
                <a href="../channels/telegram.html">Telegram</a>
                <a href="../channels/discord.html">Discord</a>
                <a href="../channels/mattermost.html">Mattermost</a>
                <a href="../channels/imessage.html">iMessage</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">Web 界面</span>
                <a href="../web/webchat.html">WebChat</a>
                <a href="../web/control-ui.html">控制界面</a>
                <a href="../web/dashboard.html">控制台</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">核心概念</span>
                <a href="../concepts/streaming.html">流式传输</a>
                <a href="../concepts/groups.html">群组</a>
                <a href="../concepts/group-messages.html">群组消息</a>
                <a href="../concepts/multi-agent.html">多代理路由</a>
                <a href="../concepts/session.html">会话</a>
                <a href="../broadcast-groups.html">广播群组</a>
                <a href="../multi-agent-sandbox-tools.html">多代理沙盒</a>
                <a href="../date-time.html">日期时间</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">自动化</span>
                <a href="../automation/cron-jobs.html">定时任务</a>
                <a href="../automation/webhook.html">Webhooks</a>
                <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                <a href="../hooks.html">钩子系统</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">工具与技能</span>
                <a href="../tools/slash-commands.html">斜杠命令</a>
                <a href="../tools/skills.html">技能</a>
                <a href="../tools/skills-config.html">技能配置</a>
                <a href="../tools/web.html">Web 工具</a>
                <a href="../brave-search.html">Brave 搜索</a>
                <a href="../perplexity.html">Perplexity</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">安装与平台</span>
                <a href="../install/updating.html">更新</a>
                <a href="../install/nix.html">Nix 模式</a>
                <a href="../platforms/macos.html">macOS</a>
                <a href="../platforms/ios.html">iOS</a>
                <a href="../platforms/android.html">Android</a>
                <a href="../platforms/windows.html">Windows (WSL2)</a>
                <a href="../platforms/linux.html">Linux</a>
                <a href="../northflank.html">Northflank 部署</a>
                <a href="../bedrock.html">AWS Bedrock</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">节点与媒体</span>
                <a href="../nodes/index.html">节点</a>
                <a href="../nodes/images.html">图片</a>
                <a href="../nodes/audio.html">音频</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">CLI 与调试</span>
                <a href="../cli/index.html">CLI 参考</a>
                <a href="../debug/node-issue.html">Node 问题</a>
                <a href="../diagnostics/flags.html">诊断标志</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">实验性</span>
                <a href="../experiments/onboarding-config-protocol.html">配置协议</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">其他</span>
                <a href="../help.html">帮助</a>
            </div>

            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>多网关</h1>
<h1>多个 Gateway（同一主机）</h1>
<p>多数设置使用一个 Gateway，因为一个 Gateway 可以处理多个消息连接和 Agent。如果你需要更强的隔离或冗余（例如救援 bot），可以运行多个隔离的 Gateway（独立 profile/端口）。</p>
<h2>隔离检查清单（必需）</h2>
<ul>
<li><code>OPENCLAW_CONFIG_PATH</code> — 每个实例独立配置文件</li>
<li><code>OPENCLAW_STATE_DIR</code> — 每个实例独立会话、凭证、缓存</li>
<li><code>agents.defaults.workspace</code> — 每个实例独立工作区根</li>
<li><code>gateway.port</code>（或 <code>--port</code>）— 每个实例唯一</li>
<li>派生端口（browser/canvas）不得冲突</li>
</ul>
<p>如果共享这些，会引发配置竞争和端口冲突。</p>
<h2>推荐：profiles（<code>--profile</code>）</h2>
<p>profiles 会自动作用于 <code>OPENCLAW_STATE_DIR</code> + <code>OPENCLAW_CONFIG_PATH</code>，并给服务名加后缀。</p>
<pre><code class="language-bash"># main
openclaw --profile main setup # 中文注释：创建 main profile
openclaw --profile main gateway --port 18789

# rescue
openclaw --profile rescue setup # 中文注释：创建 rescue profile
openclaw --profile rescue gateway --port 19001
</code></pre>
<p>每个 profile 的服务：</p>
<pre><code class="language-bash">openclaw --profile main gateway install
openclaw --profile rescue gateway install
</code></pre>
<h2>救援 Bot 指南</h2>
<p>在同一主机上运行第二个 Gateway，分别使用：</p>
<ul>
<li>profile/config</li>
<li>state 目录</li>
<li>workspace</li>
<li>基础端口（以及派生端口）</li>
</ul>
<p>这样救援 bot 与主 bot 隔离，当主 bot 出问题时可用于调试或应用配置更改。</p>
<p>端口间隔：基础端口至少相隔 20 个端口，确保派生的浏览器/canvas/CDP 端口不冲突。</p>
<h3>如何安装（救援 bot）</h3>
<pre><code class="language-bash"># 主 bot（已存在或新建，不带 --profile 参数）
# 运行在 18789 + Chrome CDC/Canvas/... 端口
openclaw onboard
openclaw gateway install

# 救援 bot（隔离 profile + 端口）
openclaw --profile rescue onboard
# 说明：
# - workspace 名称默认会加上 -rescue
# - 端口至少比 18789 大 20，最好直接选不同的基础端口，如 19789
# - 其余引导过程与正常相同

# 安装服务（如果引导未自动安装）
openclaw --profile rescue gateway install
</code></pre>
<h2>端口映射（派生）</h2>
<p>基础端口 = <code>gateway.port</code>（或 <code>OPENCLAW_GATEWAY_PORT</code> / <code>--port</code>）。</p>
<ul>
<li>浏览器控制服务端口 = 基础 + 2（仅 loopback）</li>
<li><code>canvasHost.port = base + 4</code></li>
<li>浏览器 profile 的 CDP 端口从 <code>browser.controlPort + 9 .. + 108</code> 自动分配</li>
</ul>
<p>如果你在配置或环境中覆盖了这些，需要确保每个实例唯一。</p>
<h2>浏览器/CDP 注意事项（常见坑）</h2>
<ul>
<li><strong>不要</strong>在多个实例中把 <code>browser.cdpUrl</code> 固定为相同值。</li>
<li>每个实例需要自己的浏览器控制端口和 CDP 范围（由 Gateway 端口派生）。</li>
<li>如需显式 CDP 端口，在每个实例上设置 <code>browser.profiles.&lt;name&gt;.cdpPort</code>。</li>
<li>远程 Chrome：使用 <code>browser.profiles.&lt;name&gt;.cdpUrl</code>（每个 profile、每个实例）。</li>
</ul>
<h2>手动环境示例</h2>
<pre><code class="language-bash">OPENCLAW_CONFIG_PATH=~/.openclaw/main.json \
OPENCLAW_STATE_DIR=~/.openclaw-main \
openclaw gateway --port 18789

OPENCLAW_CONFIG_PATH=~/.openclaw/rescue.json \
OPENCLAW_STATE_DIR=~/.openclaw-rescue \
openclaw gateway --port 19001
</code></pre>
<h2>快速检查</h2>
<pre><code class="language-bash">openclaw --profile main status
openclaw --profile rescue status
openclaw --profile rescue browser status
</code></pre>

        </div>
    </main>

    <script src="../assets/js/main.js?v=3"></script>
</body>
</html>
