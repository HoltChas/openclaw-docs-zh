<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发现机制 - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css?v=3">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">

            <div class="nav-section">
                <span class="nav-section-title">入门指南</span>
                <a href="../start/getting-started.html">快速入门</a>
                <a href="../start/wizard.html">向导</a>
                <a href="../start/pairing.html">配对</a>
                <a href="../start/setup.html">设置</a>
                <a href="../start/openclaw.html">OpenClaw 助手</a>
                <a href="../start/hubs.html">文档中心</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">网关配置</span>
                <a href="../gateway/configuration.html">配置</a>
                <a href="../gateway/configuration-examples.html">配置示例</a>
                <a href="../gateway/security.html">安全</a>
                <a href="../gateway/remote.html">远程访问</a>
                <a href="../gateway/tailscale.html">Tailscale</a>
                <a href="../gateway/multiple-gateways.html">多网关</a>
                <a href="../gateway/discovery.html">发现机制</a>
                <a href="../environment.html">环境变量</a>
                <a href="../logging.html">日志配置</a>
                <a href="../network.html">网络配置</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">消息渠道</span>
                <a href="../channels/whatsapp.html">WhatsApp</a>
                <a href="../channels/telegram.html">Telegram</a>
                <a href="../channels/discord.html">Discord</a>
                <a href="../channels/mattermost.html">Mattermost</a>
                <a href="../channels/imessage.html">iMessage</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">Web 界面</span>
                <a href="../web/webchat.html">WebChat</a>
                <a href="../web/control-ui.html">控制界面</a>
                <a href="../web/dashboard.html">控制台</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">核心概念</span>
                <a href="../concepts/streaming.html">流式传输</a>
                <a href="../concepts/groups.html">群组</a>
                <a href="../concepts/group-messages.html">群组消息</a>
                <a href="../concepts/multi-agent.html">多代理路由</a>
                <a href="../concepts/session.html">会话</a>
                <a href="../broadcast-groups.html">广播群组</a>
                <a href="../multi-agent-sandbox-tools.html">多代理沙盒</a>
                <a href="../date-time.html">日期时间</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">自动化</span>
                <a href="../automation/cron-jobs.html">定时任务</a>
                <a href="../automation/webhook.html">Webhooks</a>
                <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                <a href="../hooks.html">钩子系统</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">工具与技能</span>
                <a href="../tools/slash-commands.html">斜杠命令</a>
                <a href="../tools/skills.html">技能</a>
                <a href="../tools/skills-config.html">技能配置</a>
                <a href="../tools/web.html">Web 工具</a>
                <a href="../brave-search.html">Brave 搜索</a>
                <a href="../perplexity.html">Perplexity</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">安装与平台</span>
                <a href="../install/updating.html">更新</a>
                <a href="../install/nix.html">Nix 模式</a>
                <a href="../platforms/macos.html">macOS</a>
                <a href="../platforms/ios.html">iOS</a>
                <a href="../platforms/android.html">Android</a>
                <a href="../platforms/windows.html">Windows (WSL2)</a>
                <a href="../platforms/linux.html">Linux</a>
                <a href="../northflank.html">Northflank 部署</a>
                <a href="../bedrock.html">AWS Bedrock</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">节点与媒体</span>
                <a href="../nodes/index.html">节点</a>
                <a href="../nodes/images.html">图片</a>
                <a href="../nodes/audio.html">音频</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">CLI 与调试</span>
                <a href="../cli/index.html">CLI 参考</a>
                <a href="../debug/node-issue.html">Node 问题</a>
                <a href="../diagnostics/flags.html">诊断标志</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">实验性</span>
                <a href="../experiments/onboarding-config-protocol.html">配置协议</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">其他</span>
                <a href="../help.html">帮助</a>
            </div>

            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>发现机制</h1>
<h1>发现与传输</h1>
<p>OpenClaw 有两个看起来相似但实际不同的问题：</p>
<ol>
<li><strong>操作员远程控制</strong>：macOS 菜单栏应用控制运行在别处的 Gateway。</li>
<li><strong>节点配对</strong>：iOS/Android（以及未来节点）找到 Gateway 并安全配对。</li>
</ol>
<p>设计目标是将所有网络发现/广播保留在 <strong>Gateway</strong>（<code>openclaw gateway</code>），而客户端（mac 应用、iOS）只是消费者。</p>
<h2>术语</h2>
<ul>
<li><strong>Gateway</strong>：一个长期运行的 Gateway 进程，拥有状态（会话、配对、节点注册）并运行频道。多数设置每台主机一个；也支持隔离多 Gateway。</li>
<li><strong>Gateway WS（控制平面）</strong>：默认 <code>127.0.0.1:18789</code> 的 WebSocket 端点；可通过 <code>gateway.bind</code> 绑定到 LAN/tailnet。</li>
<li><strong>直连 WS 传输</strong>：LAN/tailnet 可达的 Gateway WS 端点（无需 SSH）。</li>
<li><strong>SSH 传输（回退）</strong>：通过 SSH 转发 <code>127.0.0.1:18789</code>。</li>
<li><strong>遗留 TCP bridge（已弃用/移除）</strong>：旧节点传输（见 [桥接协议(../gateway/bridge-protocol.html)）；不再广告。</li>
</ul>
<p>协议详情：</p>
<ul>
<li>[Gateway 协议(../gateway/protocol.html)</li>
<li>[桥接协议（遗留）(../gateway/bridge-protocol.html)</li>
</ul>
<h2>为什么同时保留直连和 SSH</h2>
<ul>
<li><strong>直连 WS</strong> 是同网/同 tailnet 下体验最佳：<ul>
<li>LAN 上 Bonjour 自动发现</li>
<li>Gateway 拥有配对 token + ACL</li>
<li>不需要 shell 访问；协议表面可保持紧凑可审计</li>
</ul>
</li>
<li><strong>SSH</strong> 仍是通用回退：<ul>
<li>只要你有 SSH 访问，就能跨任意网络</li>
<li>避免多播/mDNS 问题</li>
<li>不需要新的入站端口（除了 SSH）</li>
</ul>
</li>
</ul>
<h2>发现输入（客户端如何知道 Gateway）</h2>
<h3>1) Bonjour / mDNS（仅 LAN）</h3>
<p>Bonjour 是尽力而为，不跨网络，仅用于&quot;同一 LAN&quot;的便利性。</p>
<p>目标方向：</p>
<ul>
<li><strong>Gateway</strong> 广播其 WS 端点 via Bonjour。</li>
<li>客户端浏览并显示“选择 Gateway”的列表，然后保存所选端点。</li>
</ul>
<p>排查与 beacon 详情：[Bonjour(../gateway/bonjour.html)。</p>
<h4>服务 beacon 详情</h4>
<ul>
<li>服务类型：<ul>
<li><code>_openclaw-gw._tcp</code>（Gateway 传输 beacon）</li>
</ul>
</li>
<li>TXT 键（非敏感）：<ul>
<li><code>role=gateway</code></li>
<li><code>lanHost=&lt;hostname&gt;.local</code></li>
<li><code>sshPort=22</code>（或广告的端口）</li>
<li><code>gatewayPort=18789</code>（Gateway WS + HTTP）</li>
<li><code>gatewayTls=1</code>（仅当 TLS 启用）</li>
<li><code>gatewayTlsSha256=&lt;sha256&gt;</code>（仅当 TLS 启用且指纹可用）</li>
<li><code>canvasPort=18793</code>（默认 Canvas 主机端口；提供 <code>/__openclaw__/canvas/</code>）</li>
<li><code>cliPath=&lt;path&gt;</code>（可选；可运行的 <code>openclaw</code> 入口或二进制的绝对路径）</li>
<li><code>tailnetDns=&lt;magicdns&gt;</code>（可选提示；Tailscale 可用时自动检测）</li>
</ul>
</li>
</ul>
<p>禁用/覆盖：</p>
<ul>
<li><code>OPENCLAW_DISABLE_BONJOUR=1</code> 禁用广播。</li>
<li><code>gateway.bind</code> 控制 Gateway 绑定模式。</li>
<li><code>OPENCLAW_SSH_PORT</code> 覆盖 TXT 中广告的 SSH 端口（默认 22）。</li>
<li><code>OPENCLAW_TAILNET_DNS</code> 发布 <code>tailnetDns</code> 提示（MagicDNS）。</li>
<li><code>OPENCLAW_CLI_PATH</code> 覆盖广告的 CLI 路径。</li>
</ul>
<h3>2) Tailnet（跨网络）</h3>
<p>对跨城市设置，Bonjour 无效。推荐的直连目标是：</p>
<ul>
<li>Tailscale MagicDNS 名称（优先）或稳定 tailnet IP。</li>
</ul>
<p>如果 Gateway 检测到运行在 Tailscale 下，它会发布 <code>tailnetDns</code> 作为可选提示（包括广域 beacon）。</p>
<h3>3) 手动 / SSH 目标</h3>
<p>当没有直连路由（或直连被禁用），客户端总可以通过 SSH 转发 loopback Gateway 端口。</p>
<p>参见 [远程访问(../gateway/remote.html)。</p>
<h2>传输选择（客户端策略）</h2>
<p>推荐客户端行为：</p>
<ol>
<li>如果配置了已配对的直连端点且可达，使用它。</li>
<li>否则，如果 Bonjour 在 LAN 发现 Gateway，提供一键“使用此 Gateway”并保存为直连端点。</li>
<li>否则，如果配置了 tailnet DNS/IP，尝试直连。</li>
<li>否则，回退到 SSH。</li>
</ol>
<h2>配对 + 认证（直连传输）</h2>
<p>Gateway 是节点/客户端接入的真相来源。</p>
<ul>
<li>配对请求在 Gateway 中创建/批准/拒绝（见 [Gateway 配对(../gateway/pairing.html)）。</li>
<li>Gateway 强制：<ul>
<li>认证（token / keypair）</li>
<li>范围/ACL（Gateway 不是无差别代理）</li>
<li>速率限制</li>
</ul>
</li>
</ul>
<h2>组件职责</h2>
<ul>
<li><strong>Gateway</strong>：广播发现 beacon、掌握配对决策并托管 WS 端点。</li>
<li><strong>macOS 应用</strong>：帮你选择 Gateway，显示配对提示，并在必要时使用 SSH 回退。</li>
<li><strong>iOS/Android 节点</strong>：浏览 Bonjour 作为便利入口并连接到已配对的 Gateway WS。</li>
</ul>

        </div>
    </main>

    <script src="../assets/js/main.js?v=3"></script>
</body>
</html>
