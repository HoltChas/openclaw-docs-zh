<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Pub/Sub - OpenClaw æ–‡æ¡£</title>
    <link rel="stylesheet" href="../assets/css/style.css?v=3">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">ğŸ¦</span>
                <span class="logo-text">OpenClaw ä¸­æ–‡æ–‡æ¡£</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
            <div class="nav-links" id="navLinks">

            <div class="nav-section">
                <span class="nav-section-title">å…¥é—¨æŒ‡å—</span>
                <a href="../start/getting-started.html">å¿«é€Ÿå…¥é—¨</a>
                <a href="../start/wizard.html">å‘å¯¼</a>
                <a href="../start/pairing.html">é…å¯¹</a>
                <a href="../start/setup.html">è®¾ç½®</a>
                <a href="../start/openclaw.html">OpenClaw åŠ©æ‰‹</a>
                <a href="../start/hubs.html">æ–‡æ¡£ä¸­å¿ƒ</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">ç½‘å…³é…ç½®</span>
                <a href="../gateway/configuration.html">é…ç½®</a>
                <a href="../gateway/configuration-examples.html">é…ç½®ç¤ºä¾‹</a>
                <a href="../gateway/security.html">å®‰å…¨</a>
                <a href="../gateway/remote.html">è¿œç¨‹è®¿é—®</a>
                <a href="../gateway/tailscale.html">Tailscale</a>
                <a href="../gateway/multiple-gateways.html">å¤šç½‘å…³</a>
                <a href="../gateway/discovery.html">å‘ç°æœºåˆ¶</a>
                <a href="../environment.html">ç¯å¢ƒå˜é‡</a>
                <a href="../logging.html">æ—¥å¿—é…ç½®</a>
                <a href="../network.html">ç½‘ç»œé…ç½®</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">æ¶ˆæ¯æ¸ é“</span>
                <a href="../channels/whatsapp.html">WhatsApp</a>
                <a href="../channels/telegram.html">Telegram</a>
                <a href="../channels/discord.html">Discord</a>
                <a href="../channels/mattermost.html">Mattermost</a>
                <a href="../channels/imessage.html">iMessage</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">Web ç•Œé¢</span>
                <a href="../web/webchat.html">WebChat</a>
                <a href="../web/control-ui.html">æ§åˆ¶ç•Œé¢</a>
                <a href="../web/dashboard.html">æ§åˆ¶å°</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">æ ¸å¿ƒæ¦‚å¿µ</span>
                <a href="../concepts/streaming.html">æµå¼ä¼ è¾“</a>
                <a href="../concepts/groups.html">ç¾¤ç»„</a>
                <a href="../concepts/group-messages.html">ç¾¤ç»„æ¶ˆæ¯</a>
                <a href="../concepts/multi-agent.html">å¤šä»£ç†è·¯ç”±</a>
                <a href="../concepts/session.html">ä¼šè¯</a>
                <a href="../broadcast-groups.html">å¹¿æ’­ç¾¤ç»„</a>
                <a href="../multi-agent-sandbox-tools.html">å¤šä»£ç†æ²™ç›’</a>
                <a href="../date-time.html">æ—¥æœŸæ—¶é—´</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">è‡ªåŠ¨åŒ–</span>
                <a href="../automation/cron-jobs.html">å®šæ—¶ä»»åŠ¡</a>
                <a href="../automation/webhook.html">Webhooks</a>
                <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                <a href="../hooks.html">é’©å­ç³»ç»Ÿ</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">å·¥å…·ä¸æŠ€èƒ½</span>
                <a href="../tools/slash-commands.html">æ–œæ å‘½ä»¤</a>
                <a href="../tools/skills.html">æŠ€èƒ½</a>
                <a href="../tools/skills-config.html">æŠ€èƒ½é…ç½®</a>
                <a href="../tools/web.html">Web å·¥å…·</a>
                <a href="../brave-search.html">Brave æœç´¢</a>
                <a href="../perplexity.html">Perplexity</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">å®‰è£…ä¸å¹³å°</span>
                <a href="../install/updating.html">æ›´æ–°</a>
                <a href="../install/nix.html">Nix æ¨¡å¼</a>
                <a href="../platforms/macos.html">macOS</a>
                <a href="../platforms/ios.html">iOS</a>
                <a href="../platforms/android.html">Android</a>
                <a href="../platforms/windows.html">Windows (WSL2)</a>
                <a href="../platforms/linux.html">Linux</a>
                <a href="../northflank.html">Northflank éƒ¨ç½²</a>
                <a href="../bedrock.html">AWS Bedrock</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">èŠ‚ç‚¹ä¸åª’ä½“</span>
                <a href="../nodes/index.html">èŠ‚ç‚¹</a>
                <a href="../nodes/images.html">å›¾ç‰‡</a>
                <a href="../nodes/audio.html">éŸ³é¢‘</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">CLI ä¸è°ƒè¯•</span>
                <a href="../cli/index.html">CLI å‚è€ƒ</a>
                <a href="../debug/node-issue.html">Node é—®é¢˜</a>
                <a href="../diagnostics/flags.html">è¯Šæ–­æ ‡å¿—</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">å®éªŒæ€§</span>
                <a href="../experiments/onboarding-config-protocol.html">é…ç½®åè®®</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">å…¶ä»–</span>
                <a href="../help.html">å¸®åŠ©</a>
            </div>

            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>Gmail Pub/Sub</h1>
<h1>Gmail Pub/Sub -&gt; OpenClaw</h1>
<p>ç›®æ ‡ï¼šGmail ç›‘è§† -&gt; Pub/Sub æ¨é€ -&gt; <code>gog gmail watch serve</code> -&gt; OpenClaw Webhookã€‚</p>
<h2>å‰ç½®æ¡ä»¶</h2>
<ul>
<li>å·²å®‰è£…å¹¶ç™»å½• <code>gcloud</code>ï¼ˆ<a href="https://docs.cloud.google.com/sdk/docs/install-sdk">å®‰è£…æŒ‡å—</a>ï¼‰ã€‚</li>
<li>å·²å®‰è£…å¹¶æˆæƒ <code>gog</code>ï¼ˆgogcliï¼‰ç”¨äº Gmail è´¦æˆ·ï¼ˆ<a href="https://gogcli.sh/">gogcli.sh</a>ï¼‰ã€‚</li>
<li>OpenClaw Hooks å·²å¯ç”¨ï¼ˆå‚è§ [Webhooks(../automation/webhook.html)ï¼‰ã€‚</li>
<li>å·²ç™»å½• <code>tailscale</code>ï¼ˆ<a href="https://tailscale.com/">tailscale.com</a>ï¼‰ã€‚æ”¯æŒçš„è®¾ç½®ä½¿ç”¨ Tailscale Funnel ä½œä¸ºå…¬å…± HTTPS ç«¯ç‚¹ã€‚<br>å…¶ä»–éš§é“æœåŠ¡ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†éœ€è¦ DIY/ä¸æ”¯æŒï¼Œéœ€è¦æ‰‹åŠ¨æ¥çº¿ã€‚<br>ç›®å‰ï¼ŒTailscale æ˜¯æˆ‘ä»¬æ”¯æŒçš„ã€‚</li>
</ul>
<p>ç¤ºä¾‹ Hook é…ç½®ï¼ˆå¯ç”¨ Gmail é¢„è®¾æ˜ å°„ï¼‰ï¼š</p>
<pre><code class="language-json5">{
  hooks: {
    enabled: true,
    token: &quot;OPENCLAW_HOOK_TOKEN&quot;,
    path: &quot;/hooks&quot;,
    presets: [&quot;gmail&quot;]
  }
}
</code></pre>
<p>è¦å°† Gmail æ‘˜è¦ä¼ é€’åˆ°èŠå¤©ç•Œé¢ï¼Œç”¨è®¾ç½® <code>deliver</code> + å¯é€‰ <code>channel</code>/<code>to</code> çš„æ˜ å°„è¦†ç›–é¢„è®¾ï¼š</p>
<pre><code class="language-json5">{
  hooks: {
    enabled: true,
    token: &quot;OPENCLAW_HOOK_TOKEN&quot;,
    presets: [&quot;gmail&quot;],
    mappings: [
      {
        match: { path: &quot;gmail&quot; },
        action: &quot;agent&quot;,
        wakeMode: &quot;now&quot;,
        name: &quot;Gmail&quot;,
        sessionKey: &quot;hook:gmail:{{messages[0].id}}&quot;,
        messageTemplate:
          &quot;æ–°é‚®ä»¶æ¥è‡ª {{messages[0].from}}\nä¸»é¢˜ï¼š{{messages[0].subject}}\n{{messages[0].snippet}}\n{{messages[0].body}}&quot;,
        model: &quot;openai/gpt-5.2-mini&quot;,
        deliver: true,
        channel: &quot;last&quot;
        // to: &quot;+15551234567&quot;
      }
    ]
  }
}
</code></pre>
<p>å¦‚æœä½ æƒ³ä½¿ç”¨å›ºå®šé¢‘é“ï¼Œè®¾ç½® <code>channel</code> + <code>to</code>ã€‚å¦åˆ™ <code>channel: &quot;last&quot;</code> ä½¿ç”¨æœ€åä¼ é€’è·¯ç”±ï¼ˆå›é€€åˆ° WhatsAppï¼‰ã€‚</p>
<p>è¦ä¸º Gmail è¿è¡Œå¼ºåˆ¶ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹ï¼Œåœ¨æ˜ å°„ä¸­è®¾ç½® <code>model</code>ï¼ˆ<code>provider/model</code> æˆ–åˆ«åï¼‰ã€‚å¦‚æœä½ å¼ºåˆ¶æ‰§è¡Œ <code>agents.defaults.models</code>ï¼Œè¯·å°†å…¶åŒ…å«åœ¨å…¶ä¸­ã€‚</p>
<p>è¦ä¸“é—¨ä¸º Gmail Hooks è®¾ç½®é»˜è®¤æ¨¡å‹å’Œæ€è€ƒçº§åˆ«ï¼Œåœ¨é…ç½®ä¸­æ·»åŠ  <code>hooks.gmail.model</code> / <code>hooks.gmail.thinking</code>ï¼š</p>
<pre><code class="language-json5">{
  hooks: {
    gmail: {
      model: &quot;openrouter/meta-llama/llama-3.3-70b-instruct:free&quot;,
      thinking: &quot;off&quot;
    }
  }
}
</code></pre>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>æ˜ å°„ä¸­çš„æ¯ä¸ª Hook <code>model</code>/<code>thinking</code> ä»ç„¶è¦†ç›–è¿™äº›é»˜è®¤å€¼ã€‚</li>
<li>å›é€€é¡ºåºï¼š<code>hooks.gmail.model</code> â†’ <code>agents.defaults.model.fallbacks</code> â†’ ä¸»æ¨¡å‹ï¼ˆè®¤è¯/é€Ÿç‡é™åˆ¶/è¶…æ—¶ï¼‰ã€‚</li>
<li>å¦‚æœè®¾ç½®äº† <code>agents.defaults.models</code>ï¼ŒGmail æ¨¡å‹å¿…é¡»åœ¨å…è®¸åˆ—è¡¨ä¸­ã€‚</li>
<li>Gmail Hook å†…å®¹é»˜è®¤ç”¨å¤–éƒ¨å†…å®¹å®‰å…¨è¾¹ç•ŒåŒ…è£…ã€‚<br>è¦ç¦ç”¨ï¼ˆå±é™©ï¼‰ï¼Œè®¾ç½® <code>hooks.gmail.allowUnsafeExternalContent: true</code>ã€‚</li>
</ul>
<p>è¦è¿›ä¸€æ­¥è‡ªå®šä¹‰è´Ÿè½½å¤„ç†ï¼Œæ·»åŠ  <code>hooks.mappings</code> æˆ– <code>hooks.transformsDir</code> ä¸‹çš„ JS/TS è½¬æ¢æ¨¡å—<br>ï¼ˆå‚è§ [Webhooks(../automation/webhook.html)ï¼‰ã€‚</p>
<h2>å‘å¯¼ï¼ˆæ¨èï¼‰</h2>
<p>ä½¿ç”¨ OpenClaw åŠ©æ‰‹å°†æ‰€æœ‰å†…å®¹è¿æ¥åœ¨ä¸€èµ·ï¼ˆåœ¨ macOS ä¸Šé€šè¿‡ brew å®‰è£…ä¾èµ–ï¼‰ï¼š</p>
<pre><code class="language-bash">openclaw webhooks gmail setup \
  --account openclaw@gmail.com
</code></pre>
<p>é»˜è®¤å€¼ï¼š</p>
<ul>
<li>ä½¿ç”¨ Tailscale Funnel ä½œä¸ºå…¬å…±æ¨é€ç«¯ç‚¹ã€‚</li>
<li>ä¸º <code>openclaw webhooks gmail run</code> å†™å…¥ <code>hooks.gmail</code> é…ç½®ã€‚</li>
<li>å¯ç”¨ Gmail Hook é¢„è®¾ï¼ˆ<code>hooks.presets: [&quot;gmail&quot;]</code>ï¼‰ã€‚</li>
</ul>
<p>è·¯å¾„è¯´æ˜ï¼šå½“ <code>tailscale.mode</code> å¯ç”¨æ—¶ï¼ŒOpenClaw è‡ªåŠ¨å°† <code>hooks.gmail.serve.path</code> è®¾ç½®ä¸º <code>/</code>ï¼Œå¹¶å°†å…¬å…±è·¯å¾„ä¿æŒåœ¨<br><code>hooks.gmail.tailscale.path</code>ï¼ˆé»˜è®¤ <code>/gmail-pubsub</code>ï¼‰ï¼Œå› ä¸º Tailscale åœ¨ä»£ç†å‰ä¼šå‰¥ç¦»è®¾ç½®çš„è·¯å¾„å‰ç¼€ã€‚<br>å¦‚æœä½ éœ€è¦åç«¯æ¥æ”¶å¸¦å‰ç¼€çš„è·¯å¾„ï¼Œè®¾ç½® <code>hooks.gmail.tailscale.target</code>ï¼ˆæˆ– <code>--tailscale-target</code>ï¼‰ä¸ºå®Œæ•´ URL å¦‚<br><code>http://127.0.0.1:8788/gmail-pubsub</code> å¹¶åŒ¹é… <code>hooks.gmail.serve.path</code>ã€‚</p>
<p>æƒ³è¦è‡ªå®šä¹‰ç«¯ç‚¹ï¼Ÿä½¿ç”¨ <code>--push-endpoint &lt;url&gt;</code> æˆ– <code>--tailscale off</code>ã€‚</p>
<p>å¹³å°è¯´æ˜ï¼šåœ¨ macOS ä¸Šï¼Œå‘å¯¼é€šè¿‡ Homebrew å®‰è£… <code>gcloud</code>ã€<code>gogcli</code> å’Œ <code>tailscale</code>ï¼›<br>åœ¨ Linux ä¸Šå…ˆæ‰‹åŠ¨å®‰è£…å®ƒä»¬ã€‚</p>
<p>Gateway è‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èï¼‰ï¼š</p>
<ul>
<li>å½“ <code>hooks.enabled=true</code> ä¸” <code>hooks.gmail.account</code> è®¾ç½®æ—¶ï¼ŒGateway åœ¨å¯åŠ¨æ—¶å¯åŠ¨<br><code>gog gmail watch serve</code> å¹¶è‡ªåŠ¨ç»­è®¢ç›‘è§†ã€‚</li>
<li>è®¾ç½® <code>OPENCLAW_SKIP_GMAIL_WATCHER=1</code> é€‰æ‹©é€€å‡ºï¼ˆå¦‚æœä½ è‡ªå·±è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚</li>
<li>ä¸è¦åŒæ—¶è¿è¡Œæ‰‹åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå¦åˆ™ä¼šé‡åˆ°<br><code>listen tcp 127.0.0.1:8788: bind: address already in use</code>ã€‚</li>
</ul>
<p>æ‰‹åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¯åŠ¨ <code>gog gmail watch serve</code> + è‡ªåŠ¨ç»­è®¢ï¼‰ï¼š</p>
<pre><code class="language-bash">openclaw webhooks gmail run
</code></pre>
<h2>ä¸€æ¬¡æ€§è®¾ç½®</h2>
<ol>
<li>é€‰æ‹© <strong>æ‹¥æœ‰ OAuth å®¢æˆ·ç«¯</strong>çš„ GCP é¡¹ç›®ï¼Œè¯¥å®¢æˆ·ç«¯ç”¨äº <code>gog</code>ã€‚</li>
</ol>
<pre><code class="language-bash">gcloud auth login
gcloud config set project &lt;project-id&gt;
</code></pre>
<p>æ³¨æ„ï¼šGmail ç›‘è§†è¦æ±‚ Pub/Sub ä¸»é¢˜ä¸ OAuth å®¢æˆ·ç«¯åœ¨åŒä¸€é¡¹ç›®ä¸­ã€‚</p>
<ol start="2">
<li>å¯ç”¨ APIï¼š</li>
</ol>
<pre><code class="language-bash">gcloud services enable gmail.googleapis.com pubsub.googleapis.com
</code></pre>
<ol start="3">
<li>åˆ›å»ºä¸»é¢˜ï¼š</li>
</ol>
<pre><code class="language-bash">gcloud pubsub topics create gog-gmail-watch
</code></pre>
<ol start="4">
<li>å…è®¸ Gmail æ¨é€å‘å¸ƒï¼š</li>
</ol>
<pre><code class="language-bash">gcloud pubsub topics add-iam-policy-binding gog-gmail-watch \
  --member=serviceAccount:gmail-api-push@system.gserviceaccount.com \
  --role=roles/pubsub.publisher
</code></pre>
<h2>å¯åŠ¨ç›‘è§†</h2>
<pre><code class="language-bash">gog gmail watch start \
  --account openclaw@gmail.com \
  --label INBOX \
  --topic projects/&lt;project-id&gt;/topics/gog-gmail-watch
</code></pre>
<p>ä¿å­˜è¾“å‡ºä¸­çš„ <code>history_id</code>ï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚</p>
<h2>è¿è¡Œæ¨é€å¤„ç†å™¨</h2>
<p>æœ¬åœ°ç¤ºä¾‹ï¼ˆå…±äº« token è®¤è¯ï¼‰ï¼š</p>
<pre><code class="language-bash">gog gmail watch serve \
  --account openclaw@gmail.com \
  --bind 127.0.0.1 \
  --port 8788 \
  --path /gmail-pubsub \
  --token &lt;shared&gt; \
  --hook-url http://127.0.0.1:18789/hooks/gmail \
  --hook-token OPENCLAW_HOOK_TOKEN \
  --include-body \
  --max-bytes 20000
</code></pre>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>--token</code> ä¿æŠ¤æ¨é€ç«¯ç‚¹ï¼ˆ<code>x-gog-token</code> æˆ– <code>?token=</code>ï¼‰ã€‚</li>
<li><code>--hook-url</code> æŒ‡å‘ OpenClaw <code>/hooks/gmail</code>ï¼ˆå·²æ˜ å°„ï¼›ç‹¬ç«‹è¿è¡Œ + æ‘˜è¦åˆ°ä¸»ä¼šè¯ï¼‰ã€‚</li>
<li><code>--include-body</code> å’Œ <code>--max-bytes</code> æ§åˆ¶å‘é€åˆ° OpenClaw çš„æ­£æ–‡ç‰‡æ®µã€‚</li>
</ul>
<p>æ¨èï¼š<code>openclaw webhooks gmail run</code> åŒ…è£…ç›¸åŒçš„æµç¨‹å¹¶è‡ªåŠ¨ç»­è®¢ç›‘è§†ã€‚</p>
<h2>æš´éœ²å¤„ç†å™¨ï¼ˆé«˜çº§ï¼Œä¸æ”¯æŒï¼‰</h2>
<p>å¦‚æœä½ éœ€è¦é Tailscale éš§é“ï¼Œæ‰‹åŠ¨æ¥çº¿å¹¶ä½¿ç”¨å…¬å…± URL ä½œä¸ºæ¨é€è®¢é˜…ï¼ˆä¸æ”¯æŒï¼Œæ— ä¿æŠ¤ï¼‰ï¼š</p>
<pre><code class="language-bash">cloudflared tunnel --url http://127.0.0.1:8788 --no-autoupdate
</code></pre>
<p>ä½¿ç”¨ç”Ÿæˆçš„ URL ä½œä¸ºæ¨é€ç«¯ç‚¹ï¼š</p>
<pre><code class="language-bash">gcloud pubsub subscriptions create gog-gmail-watch-push \
  --topic gog-gmail-watch \
  --push-endpoint &quot;https://&lt;public-url&gt;/gmail-pubsub?token=&lt;shared&gt;&quot;
</code></pre>
<p>ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ç¨³å®šçš„ HTTPS ç«¯ç‚¹å¹¶é…ç½® Pub/Sub OIDC JWTï¼Œç„¶åè¿è¡Œï¼š</p>
<pre><code class="language-bash">gog gmail watch serve --verify-oidc --oidc-email &lt;svc@...&gt;
</code></pre>
<h2>æµ‹è¯•</h2>
<p>å‘é€æ¶ˆæ¯åˆ°ç›‘è§†çš„æ”¶ä»¶ç®±ï¼š</p>
<pre><code class="language-bash">gog gmail send \
  --account openclaw@gmail.com \
  --to openclaw@gmail.com \
  --subject &quot;watch test&quot; \
  --body &quot;ping&quot;
</code></pre>
<p>æ£€æŸ¥ç›‘è§†çŠ¶æ€å’Œå†å²ï¼š</p>
<pre><code class="language-bash">gog gmail watch status --account openclaw@gmail.com
gog gmail history --account openclaw@gmail.com --since &lt;historyId&gt;
</code></pre>
<h2>æ•…éšœæ’æŸ¥</h2>
<ul>
<li><code>Invalid topicName</code>ï¼šé¡¹ç›®ä¸åŒ¹é…ï¼ˆä¸»é¢˜ä¸åœ¨ OAuth å®¢æˆ·ç«¯é¡¹ç›®ä¸­ï¼‰ã€‚</li>
<li><code>User not authorized</code>ï¼šä¸»é¢˜ä¸Šç¼ºå°‘ <code>roles/pubsub.publisher</code>ã€‚</li>
<li>ç©ºæ¶ˆæ¯ï¼šGmail æ¨é€ä»…æä¾› <code>historyId</code>ï¼›é€šè¿‡ <code>gog gmail history</code> è·å–ã€‚</li>
</ul>
<h2>æ¸…ç†</h2>
<pre><code class="language-bash">gog gmail watch stop --account openclaw@gmail.com
gcloud pubsub subscriptions delete gog-gmail-watch-push
gcloud pubsub topics delete gog-gmail-watch
</code></pre>

        </div>
    </main>

    <script src="../assets/js/main.js?v=3"></script>
</body>
</html>
