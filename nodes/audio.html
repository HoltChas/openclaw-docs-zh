<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频 - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">

            <div class="nav-section">
                <span class="nav-section-title">入门指南</span>
                <a href="../start/getting-started.html">快速入门</a>
                <a href="../start/wizard.html">向导</a>
                <a href="../start/pairing.html">配对</a>
                <a href="../start/setup.html">设置</a>
                <a href="../start/openclaw.html">OpenClaw 助手</a>
                <a href="../start/hubs.html">文档中心</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">网关配置</span>
                <a href="../gateway/configuration.html">配置</a>
                <a href="../gateway/configuration-examples.html">配置示例</a>
                <a href="../gateway/security.html">安全</a>
                <a href="../gateway/remote.html">远程访问</a>
                <a href="../gateway/tailscale.html">Tailscale</a>
                <a href="../gateway/multiple-gateways.html">多网关</a>
                <a href="../gateway/discovery.html">发现机制</a>
                <a href="../environment.html">环境变量</a>
                <a href="../logging.html">日志配置</a>
                <a href="../network.html">网络配置</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">消息渠道</span>
                <a href="../channels/whatsapp.html">WhatsApp</a>
                <a href="../channels/telegram.html">Telegram</a>
                <a href="../channels/discord.html">Discord</a>
                <a href="../channels/mattermost.html">Mattermost</a>
                <a href="../channels/imessage.html">iMessage</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">Web 界面</span>
                <a href="../web/webchat.html">WebChat</a>
                <a href="../web/control-ui.html">控制界面</a>
                <a href="../web/dashboard.html">控制台</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">核心概念</span>
                <a href="../concepts/streaming.html">流式传输</a>
                <a href="../concepts/groups.html">群组</a>
                <a href="../concepts/group-messages.html">群组消息</a>
                <a href="../concepts/multi-agent.html">多代理路由</a>
                <a href="../concepts/session.html">会话</a>
                <a href="../broadcast-groups.html">广播群组</a>
                <a href="../multi-agent-sandbox-tools.html">多代理沙盒</a>
                <a href="../date-time.html">日期时间</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">自动化</span>
                <a href="../automation/cron-jobs.html">定时任务</a>
                <a href="../automation/webhook.html">Webhooks</a>
                <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                <a href="../hooks.html">钩子系统</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">工具与技能</span>
                <a href="../tools/slash-commands.html">斜杠命令</a>
                <a href="../tools/skills.html">技能</a>
                <a href="../tools/skills-config.html">技能配置</a>
                <a href="../tools/web.html">Web 工具</a>
                <a href="../brave-search.html">Brave 搜索</a>
                <a href="../perplexity.html">Perplexity</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">安装与平台</span>
                <a href="../install/updating.html">更新</a>
                <a href="../install/nix.html">Nix 模式</a>
                <a href="../platforms/macos.html">macOS</a>
                <a href="../platforms/ios.html">iOS</a>
                <a href="../platforms/android.html">Android</a>
                <a href="../platforms/windows.html">Windows (WSL2)</a>
                <a href="../platforms/linux.html">Linux</a>
                <a href="../northflank.html">Northflank 部署</a>
                <a href="../bedrock.html">AWS Bedrock</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">节点与媒体</span>
                <a href="../nodes/index.html">节点</a>
                <a href="../nodes/images.html">图片</a>
                <a href="../nodes/audio.html">音频</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">CLI 与调试</span>
                <a href="../cli/index.html">CLI 参考</a>
                <a href="../debug/node-issue.html">Node 问题</a>
                <a href="../diagnostics/flags.html">诊断标志</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">实验性</span>
                <a href="../experiments/onboarding-config-protocol.html">配置协议</a>
            </div>
            <div class="nav-section">
                <span class="nav-section-title">其他</span>
                <a href="../help.html">帮助</a>
            </div>

            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>音频</h1>
<h1>音频 / 语音笔记 — 2026-01-17</h1>
<h2>功能</h2>
<ul>
<li><strong>媒体理解（音频）</strong>：如果启用音频理解（或自动检测），OpenClaw：<ol>
<li>定位第一个音频附件（本地路径或 URL）并在需要时下载。</li>
<li>在发送到每个模型条目之前强制执行 <code>maxBytes</code>。</li>
<li>按顺序运行第一个符合条件的模型条目（Provider 或 CLI）。</li>
<li>如果失败或跳过（大小/超时），尝试下一个条目。</li>
<li>成功时，用 <code>[Audio]</code> 块替换 <code>Body</code> 并设置 <code>{{Transcript}}</code>。</li>
</ol>
</li>
<li><strong>命令解析</strong>：当转录成功时，<code>CommandBody</code>/<code>RawBody</code> 被设置为转录本，以便斜杠命令仍然有效。</li>
<li><strong>详细日志记录</strong>：在 <code>--verbose</code> 中，我们记录转录何时运行以及何时替换正文。</li>
</ul>
<h2>自动检测（默认）</h2>
<p>如果你 <strong>不配置模型</strong> 且 <code>tools.media.audio.enabled</code> <strong>未</strong>设置为 <code>false</code>，<br>OpenClaw 按此顺序自动检测并在第一个可用选项处停止：</p>
<ol>
<li><strong>本地 CLI</strong>（如果已安装）<ul>
<li><code>sherpa-onnx-offline</code>（需要带 encoder/decoder/joiner/tokens 的 <code>SHERPA_ONNX_MODEL_DIR</code>）</li>
<li><code>whisper-cli</code>（来自 <code>whisper-cpp</code>；使用 <code>WHISPER_CPP_MODEL</code> 或捆绑的 tiny 模型）</li>
<li><code>whisper</code>（Python CLI；自动下载模型）</li>
</ul>
</li>
<li><strong>Gemini CLI</strong> (<code>gemini</code>) 使用 <code>read_many_files</code></li>
<li><strong>Provider 密钥</strong>（OpenAI → Groq → Deepgram → Google）</li>
</ol>
<p>要禁用自动检测，设置 <code>tools.media.audio.enabled: false</code>。<br>要自定义，设置 <code>tools.media.audio.models</code>。<br>注意：二进制检测在 macOS/Linux/Windows 上是尽力而为；确保 CLI 在 <code>PATH</code> 上（我们扩展 <code>~</code>），或为显式 CLI 模型设置完整命令路径。</p>
<h2>配置示例</h2>
<h3>Provider + CLI 回退（OpenAI + Whisper CLI）</h3>
<pre><code class="language-json5">{
  tools: {
    media: {
      audio: {
        enabled: true,
        maxBytes: 20971520,
        models: [
          { provider: &quot;openai&quot;, model: &quot;gpt-4o-mini-transcribe&quot; },
          {
            type: &quot;cli&quot;,
            command: &quot;whisper&quot;,
            args: [&quot;--model&quot;, &quot;base&quot;, &quot;{{MediaPath}}&quot;],
            timeoutSeconds: 45
          }
        ]
      }
    }
  }
}
</code></pre>
<h3>仅 Provider 带范围门控</h3>
<pre><code class="language-json5">{
  tools: {
    media: {
      audio: {
        enabled: true,
        scope: {
          default: &quot;allow&quot;,
          rules: [
            { action: &quot;deny&quot;, match: { chatType: &quot;group&quot; } }
          ]
        },
        models: [
          { provider: &quot;openai&quot;, model: &quot;gpt-4o-mini-transcribe&quot; }
        ]
      }
    }
  }
}
</code></pre>
<h3>仅 Provider（Deepgram）</h3>
<pre><code class="language-json5">{
  tools: {
    media: {
      audio: {
        enabled: true,
        models: [{ provider: &quot;deepgram&quot;, model: &quot;nova-3&quot; }]
      }
    }
  }
}
</code></pre>
<h2>说明和限制</h2>
<ul>
<li>Provider 认证遵循标准模型认证顺序（认证配置文件、环境变量、<code>models.providers.*.apiKey</code>）。</li>
<li>使用 <code>provider: &quot;deepgram&quot;</code> 时，Deepgram 拾取 <code>DEEPGRAM_API_KEY</code>。</li>
<li>Deepgram 设置详情：<a href="/providers/deepgram">Deepgram（音频转录）</a>。</li>
<li>音频 Provider 可以通过 <code>tools.media.audio</code> 覆盖 <code>baseUrl</code>、<code>headers</code> 和 <code>providerOptions</code>。</li>
<li>默认大小上限为 20MB（<code>tools.media.audio.maxBytes</code>）。超大音频跳过该模型并尝试下一个条目。</li>
<li>音频的默认 <code>maxChars</code> 为 <strong>未设置</strong>（完整转录）。设置 <code>tools.media.audio.maxChars</code> 或每个条目的 <code>maxChars</code> 以修剪输出。</li>
<li>OpenAI 自动默认为 <code>gpt-4o-mini-transcribe</code>；设置 <code>model: &quot;gpt-4o-transcribe&quot;</code> 以获得更高准确性。</li>
<li>使用 <code>tools.media.audio.attachments</code> 处理多个语音笔记（<code>mode: &quot;all&quot;</code> + <code>maxAttachments</code>）。</li>
<li>转录本作为 <code>{{Transcript}}</code> 可用于模板。</li>
<li>CLI stdout 被限制（5MB）；保持 CLI 输出简洁。</li>
</ul>
<h2>注意事项</h2>
<ul>
<li>范围规则使用先到先得。<code>chatType</code> 被规范化为 <code>direct</code>、<code>group</code> 或 <code>room</code>。</li>
<li>确保你的 CLI 退出 0 并打印纯文本；JSON 需要通过 <code>jq -r .text</code> 处理。</li>
<li>保持超时合理（<code>timeoutSeconds</code>，默认 60s）以避免阻塞回复队列。</li>
</ul>

        </div>
    </main>

    <script src="../assets/js/main.js"></script>
</body>
</html>
