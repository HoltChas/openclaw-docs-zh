<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">
                <div class="nav-section">
                    <span class="nav-section-title">入门指南</span>
                    <a href="../start/getting-started.html">快速入门</a>
                    <a href="../start/wizard.html">向导</a>
                    <a href="../start/pairing.html">配对</a>
                    <a href="../start/setup.html">设置</a>
                    <a href="../start/openclaw.html">OpenClaw 助手</a>
                    <a href="../start/hubs.html">文档中心</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">网关配置</span>
                    <a href="../gateway/configuration.html">配置</a>
                    <a href="../gateway/configuration-examples.html">配置示例</a>
                    <a href="../gateway/security.html">安全</a>
                    <a href="../gateway/remote.html">远程访问</a>
                    <a href="../gateway/tailscale.html">Tailscale</a>
                    <a href="../gateway/multiple-gateways.html">多网关</a>
                    <a href="../gateway/discovery.html">发现机制</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">消息渠道</span>
                    <a href="../channels/whatsapp.html">WhatsApp</a>
                    <a href="../channels/telegram.html">Telegram</a>
                    <a href="../channels/discord.html">Discord</a>
                    <a href="../channels/mattermost.html">Mattermost</a>
                    <a href="../channels/imessage.html">iMessage</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">Web 界面</span>
                    <a href="../web/webchat.html">WebChat</a>
                    <a href="../web/control-ui.html">控制界面</a>
                    <a href="../web/dashboard.html">控制台</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">核心概念</span>
                    <a href="../concepts/streaming.html">流式传输</a>
                    <a href="../concepts/groups.html">群组</a>
                    <a href="../concepts/group-messages.html">群组消息</a>
                    <a href="../concepts/multi-agent.html">多代理路由</a>
                    <a href="../concepts/session.html">会话</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">自动化</span>
                    <a href="../automation/cron-jobs.html">定时任务</a>
                    <a href="../automation/webhook.html">Webhooks</a>
                    <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">工具与技能</span>
                    <a href="../tools/slash-commands.html">斜杠命令</a>
                    <a href="../tools/skills.html">技能</a>
                    <a href="../tools/skills-config.html">技能配置</a>
                    <a href="../tools/web.html">Web 工具</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">安装与平台</span>
                    <a href="../install/updating.html">更新</a>
                    <a href="../install/nix.html">Nix 模式</a>
                    <a href="../platforms/macos.html">macOS</a>
                    <a href="../platforms/ios.html">iOS</a>
                    <a href="../platforms/android.html">Android</a>
                    <a href="../platforms/windows.html">Windows (WSL2)</a>
                    <a href="../platforms/linux.html">Linux</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">节点与媒体</span>
                    <a href="../nodes/index.html">节点</a>
                    <a href="../nodes/images.html">图片</a>
                    <a href="../nodes/audio.html">音频</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">其他</span>
                    <a href="../help.html">帮助</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>WhatsApp（网页渠道）</h1>

            <p>状态：仅通过 Baileys 使用 WhatsApp Web。网关拥有会话。</p>

            <h2>快速设置（初学者）</h2>
            <ol>
                <li>如果可能，使用<strong>单独的电话号码</strong>（推荐）。</li>
                <li>在 <code>~/.openclaw/openclaw.json</code> 中配置 WhatsApp。</li>
                <li>运行 <code>openclaw channels login</code> 扫描二维码（关联设备）。</li>
                <li>启动网关。</li>
            </ol>

            <p>最小配置：</p>
            <pre><code>{
  channels: {
    whatsapp: {
      dmPolicy: "allowlist",
      allowFrom: ["+15551234567"]
    }
  }
}</code></pre>

            <h2>目标</h2>
            <ul>
                <li>在一个网关进程中运行多个 WhatsApp 账户（多账户）。</li>
                <li>确定性路由：回复返回到 WhatsApp，无模型路由。</li>
                <li>模型看到足够的上下文来理解引用回复。</li>
            </ul>

            <h2>获取电话号码（两种模式）</h2>

            <p>WhatsApp 需要真实的手机号码进行验证。VoIP 和虚拟号码通常被阻止。有两种支持的方式在 WhatsApp 上运行 OpenClaw：</p>

            <h3>专用号码（推荐）</h3>
            <p>为 OpenClaw 使用<strong>单独的电话号码</strong>。最佳用户体验、干净路由、无自聊天怪癖。理想设置：<strong>备用/旧 Android 手机 + eSIM</strong>。保持 Wi-Fi 和电源连接，并通过 QR 链接。</p>

            <p><strong>WhatsApp Business：</strong>你可以在同一设备上使用不同的号码运行 WhatsApp Business。非常适合保持个人 WhatsApp 分开 — 安装 WhatsApp Business 并在那里注册 OpenClaw 号码。</p>

            <h3>个人号码（回退）</h3>
            <p>快速回退：在<strong>你自己的号码</strong>上运行 OpenClaw。给自己发消息（WhatsApp "Message yourself"）进行测试，这样你就不会打扰联系人。在设置和实验期间，期望在你的主手机上读取验证码。<strong>必须启用自聊天模式。</strong></p>

            <h2>为什么不使用 Twilio？</h2>
            <ul>
                <li>早期 OpenClaw 构建支持 Twilio 的 WhatsApp Business 集成。</li>
                <li>WhatsApp Business 号码不适合个人助理。</li>
                <li>Meta 强制执行 24 小时回复窗口；如果你在过去 24 小时内没有回复，企业号码无法发起新消息。</li>
                <li>高容量或"聊天"使用会触发积极阻止，因为企业账户不意味着发送数十条个人助理消息。</li>
                <li>结果：不可靠的投递和频繁阻止，因此移除了支持。</li>
            </ul>

            <h2>登录 + 凭证</h2>
            <ul>
                <li>登录命令：<code>openclaw channels login</code>（通过关联设备的 QR）。</li>
                <li>多账户登录：<code>openclaw channels login --account &lt;id&gt;</code>（<code>&lt;id&gt;</code> = <code>accountId</code>）。</li>
                <li>默认账户（省略 <code>--account</code> 时）：如果存在则为 <code>default</code>，否则为第一个配置账户 id（排序）。</li>
                <li>凭证存储在 <code>~/.openclaw/credentials/whatsapp/&lt;accountId&gt;/creds.json</code>。</li>
                <li>备份副本在 <code>creds.json.bak</code>（损坏时恢复）。</li>
                <li>注销：<code>openclaw channels logout</code>（或 <code>--account &lt;id&gt;</code>）删除 WhatsApp 认证状态（但保留共享的 <code>oauth.json</code>）。</li>
            </ul>

            <h2>DM 策略</h2>
            <p><code>channels.whatsapp.dmPolicy</code> 控制直接聊天（DM）的处理方式：</p>
            <ul>
                <li><code>"pairing"</code>（默认）：未知发送者获得配对代码；所有者必须批准</li>
                <li><code>"allowlist"</code>：只允许 <code>channels.whatsapp.allowFrom</code> 中的发送者（或配对允许存储）</li>
                <li><code>"open"</code>：允许所有入站 DM（<strong>需要</strong> <code>channels.whatsapp.allowFrom</code> 包含 <code>"*"</code>）</li>
                <li><code>"disabled"</code>：忽略所有入站 DM</li>
            </ul>

            <h2>已读回执</h2>
            <p>默认情况下，网关在消息被接受后将入站 WhatsApp 消息标记为已读（蓝色对勾）。</p>

            <p>全局禁用：</p>
            <pre><code>{
  channels: { whatsapp: { sendReadReceipts: false } }
}</code></pre>

            <h2>群组</h2>
            <ul>
                <li>群组映射到 <code>agent:&lt;agentId&gt;:whatsapp:group:&lt;jid&gt;</code> 会话。</li>
                <li>群组策略：<code>channels.whatsapp.groupPolicy = open|disabled|allowlist</code>（默认 <code>allowlist</code>）。</li>
                <li>激活模式：<code>mention</code>（默认）需要 @提及或正则匹配；<code>always</code> 始终触发。</li>
            </ul>

            <h2>限制</h2>
            <ul>
                <li>出站文本被分块到 <code>channels.whatsapp.textChunkLimit</code>（默认 4000）。</li>
                <li>可选换行分块：设置 <code>channels.whatsapp.chunkMode="newline"</code> 以在长度分块之前在空白行（段落边界）分割。</li>
                <li>入站媒体保存上限为 <code>channels.whatsapp.mediaMaxMb</code>（默认 50 MB）。</li>
                <li>出站媒体项目上限为 <code>agents.defaults.mediaMaxMb</code>（默认 5 MB）。</li>
            </ul>

            <h2>故障排除（快速）</h2>

            <h3>未链接 / 需要 QR 登录</h3>
            <ul>
                <li>症状：<code>channels status</code> 显示 <code>linked: false</code> 或警告 "Not linked"。</li>
                <li>修复：在网关主机上运行 <code>openclaw channels login</code> 并扫描 QR（WhatsApp → 设置 → 关联设备）。</li>
            </ul>

            <h3>已链接但断开连接 / 重新连接循环</h3>
            <ul>
                <li>症状：<code>channels status</code> 显示 <code>running, disconnected</code> 或警告 "Linked but disconnected"。</li>
                <li>修复：<code>openclaw doctor</code>（或重启网关）。如果持续存在，通过 <code>channels login</code> 重新链接并检查 <code>openclaw logs --follow</code>。</li>
            </ul>

            <h3>Bun 运行时</h3>
            <ul>
                <li><strong>不推荐</strong> Bun。WhatsApp（Baileys）和 Telegram 在 Bun 上不可靠。使用 <strong>Node</strong> 运行网关。</li>
            </ul>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>OpenClaw = CLAW + TARDIS — 因为每只太空龙虾都需要一台时空机器</p>
            <p>"我们都在玩自己的提示词。" — 某个 AI，大概 token 嗨了</p>
            <p class="license">MIT 协议 — 像海洋中的龙虾一样自由 🦞</p>
        </div>
    </footer>

    <script src="../assets/js/main.js"></script>
</body>
</html>
