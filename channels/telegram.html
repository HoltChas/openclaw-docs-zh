<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram - OpenClaw 文档</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">🦞</span>
                <span class="logo-text">OpenClaw 中文文档</span>
            </a>
            <button class="nav-toggle" onclick="toggleNav()">☰</button>
            <div class="nav-links" id="navLinks">
                <div class="nav-section">
                    <span class="nav-section-title">入门指南</span>
                    <a href="../start/getting-started.html">快速入门</a>
                    <a href="../start/wizard.html">向导</a>
                    <a href="../start/pairing.html">配对</a>
                    <a href="../start/setup.html">设置</a>
                    <a href="../start/openclaw.html">OpenClaw 助手</a>
                    <a href="../start/hubs.html">文档中心</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">网关配置</span>
                    <a href="../gateway/configuration.html">配置</a>
                    <a href="../gateway/configuration-examples.html">配置示例</a>
                    <a href="../gateway/security.html">安全</a>
                    <a href="../gateway/remote.html">远程访问</a>
                    <a href="../gateway/tailscale.html">Tailscale</a>
                    <a href="../gateway/multiple-gateways.html">多网关</a>
                    <a href="../gateway/discovery.html">发现机制</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">消息渠道</span>
                    <a href="../channels/whatsapp.html">WhatsApp</a>
                    <a href="../channels/telegram.html">Telegram</a>
                    <a href="../channels/discord.html">Discord</a>
                    <a href="../channels/mattermost.html">Mattermost</a>
                    <a href="../channels/imessage.html">iMessage</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">Web 界面</span>
                    <a href="../web/webchat.html">WebChat</a>
                    <a href="../web/control-ui.html">控制界面</a>
                    <a href="../web/dashboard.html">控制台</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">核心概念</span>
                    <a href="../concepts/streaming.html">流式传输</a>
                    <a href="../concepts/groups.html">群组</a>
                    <a href="../concepts/group-messages.html">群组消息</a>
                    <a href="../concepts/multi-agent.html">多代理路由</a>
                    <a href="../concepts/session.html">会话</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">自动化</span>
                    <a href="../automation/cron-jobs.html">定时任务</a>
                    <a href="../automation/webhook.html">Webhooks</a>
                    <a href="../automation/gmail-pubsub.html">Gmail Pub/Sub</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">工具与技能</span>
                    <a href="../tools/slash-commands.html">斜杠命令</a>
                    <a href="../tools/skills.html">技能</a>
                    <a href="../tools/skills-config.html">技能配置</a>
                    <a href="../tools/web.html">Web 工具</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">安装与平台</span>
                    <a href="../install/updating.html">更新</a>
                    <a href="../install/nix.html">Nix 模式</a>
                    <a href="../platforms/macos.html">macOS</a>
                    <a href="../platforms/ios.html">iOS</a>
                    <a href="../platforms/android.html">Android</a>
                    <a href="../platforms/windows.html">Windows (WSL2)</a>
                    <a href="../platforms/linux.html">Linux</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">节点与媒体</span>
                    <a href="../nodes/index.html">节点</a>
                    <a href="../nodes/images.html">图片</a>
                    <a href="../nodes/audio.html">音频</a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">其他</span>
                    <a href="../help.html">帮助</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="overlay" onclick="toggleNav()"></div>

    <main class="main-content">
        <div class="content">
            <h1>Telegram（机器人 API）</h1>

            <p>状态：通过 grammY 为机器人 DM + 群组提供生产就绪支持。默认长轮询；可选 webhook。</p>

            <h2>快速设置（初学者）</h2>
            <ol>
                <li>使用 <strong>@BotFather</strong> 创建机器人并复制令牌。</li>
                <li>设置令牌：
                    <ul>
                        <li>环境变量：<code>TELEGRAM_BOT_TOKEN=...</code></li>
                        <li>或配置：<code>channels.telegram.botToken: "..."</code></li>
                        <li>如果两者都设置，配置优先（环境回退仅默认账户）。</li>
                    </ul>
                </li>
                <li>启动网关。</li>
                <li>DM 访问默认是配对；首次联系时批准配对代码。</li>
            </ol>

            <p>最小配置：</p>
            <pre><code>{
  channels: {
    telegram: {
      enabled: true,
      botToken: "123:abc",
      dmPolicy: "pairing"
    }
  }
}</code></pre>

            <h2>设置（快速路径）</h2>

            <h3>1) 创建机器人令牌（BotFather）</h3>
            <ol>
                <li>打开 Telegram 并与 <strong>@BotFather</strong> 聊天。</li>
                <li>运行 <code>/newbot</code>，然后按照提示操作（名称 + 以 <code>bot</code> 结尾的用户名）。</li>
                <li>复制令牌并安全存储。</li>
            </ol>

            <p>可选的 BotFather 设置：</p>
            <ul>
                <li><code>/setjoingroups</code> — 允许/拒绝将机器人添加到群组。</li>
                <li><code>/setprivacy</code> — 控制机器人是否看到所有群组消息。</li>
            </ul>

            <h3>2) 配置令牌（环境变量或配置）</h3>
            <p>示例：</p>
            <pre><code>{
  channels: {
    telegram: {
      enabled: true,
      botToken: "123:abc",
      dmPolicy: "pairing",
      groups: { "*": { requireMention: true } }
    }
  }
}</code></pre>

            <p>环境选项：<code>TELEGRAM_BOT_TOKEN=...</code>（适用于默认账户）。如果环境和配置都设置，配置优先。</p>

            <h2>令牌 + 隐私 + 权限（Telegram 端）</h2>

            <h3>令牌创建（BotFather）</h3>
            <ul>
                <li><code>/newbot</code> 创建机器人并返回令牌（保密）。</li>
                <li>如果令牌泄露，通过 @BotFather 撤销/重新生成并更新你的配置。</li>
            </ul>

            <h3>群组消息可见性（隐私模式）</h3>
            <p>Telegram 机器人默认为<strong>隐私模式</strong>，这限制它们接收的群组消息。如果你的机器人必须看到<em>所有</em>群组消息，你有两个选项：</p>
            <ul>
                <li>使用 <code>/setprivacy</code> 禁用隐私模式，<strong>或</strong></li>
                <li>将机器人添加为群组<strong>管理员</strong>（管理员机器人接收所有消息）。</li>
            </ul>
            <p><strong>注意：</strong>切换隐私模式时，Telegram 需要从每个群组移除 + 重新添加机器人才能使更改生效。</p>

            <h2>工作原理（行为）</h2>
            <ul>
                <li>入站消息被规范化为共享的渠道信封，带有回复上下文和媒体占位符。</li>
                <li>群组回复默认需要提及（原生 @提及或 <code>agents.list[].groupChat.mentionPatterns</code> / <code>messages.groupChat.mentionPatterns</code>）。</li>
                <li>多代理覆盖：在 <code>agents.list[].groupChat.mentionPatterns</code> 上设置每个代理的模式。</li>
                <li>回复始终路由回同一个 Telegram 聊天。</li>
                <li>长轮询使用 grammY runner 进行每聊天排序；总体并发由 <code>agents.defaults.maxConcurrent</code> 限制。</li>
                <li>Telegram Bot API 不支持已读回执；没有 <code>sendReadReceipts</code> 选项。</li>
            </ul>

            <h2>群组激活模式</h2>
            <p>默认情况下，机器人只在群组中响应提及（<code>@botname</code> 或 <code>agents.list[].groupChat.mentionPatterns</code> 中的模式）。要更改此行为：</p>

            <h3>通过配置（推荐）</h3>
            <pre><code>{
  channels: {
    telegram: {
      groups: {
        "-1001234567890": { requireMention: false }  // 在此群组中始终响应
      }
    }
  }
}</code></pre>

            <p><strong>重要：</strong>设置 <code>channels.telegram.groups</code> 会创建一个<strong>白名单</strong> - 只有列出的群组（或 <code>"*"</code>）会被接受。</p>

            <h2>访问控制（DM + 群组）</h2>

            <h3>DM 访问</h3>
            <ul>
                <li>默认：<code>channels.telegram.dmPolicy = "pairing"</code>。未知发送者收到配对代码；消息在批准之前被忽略（代码在 1 小时后过期）。</li>
                <li>通过以下方式批准：
                    <ul>
                        <li><code>openclaw pairing list telegram</code></li>
                        <li><code>openclaw pairing approve telegram &lt;CODE&gt;</code></li>
                    </ul>
                </li>
            </ul>

            <h3>查找你的 Telegram 用户 ID</h3>
            <p>更安全（无第三方机器人）：</p>
            <ol>
                <li>启动网关并向你的机器人发送 DM。</li>
                <li>运行 <code>openclaw logs --follow</code> 并查找 <code>from.id</code>。</li>
            </ol>

            <h2>长轮询 vs Webhook</h2>
            <ul>
                <li>默认：长轮询（不需要公共 URL）。</li>
                <li>Webhook 模式：设置 <code>channels.telegram.webhookUrl</code>（可选 <code>channels.telegram.webhookSecret</code> + <code>channels.telegram.webhookPath</code>）。</li>
            </ul>

            <h2>故障排除</h2>

            <h3>机器人在群组中不响应非提及消息</h3>
            <ul>
                <li>如果你设置 <code>channels.telegram.groups.*.requireMention=false</code>，Telegram 的 Bot API <strong>隐私模式</strong>必须被禁用。
                    <ul>
                        <li>BotFather：<code>/setprivacy</code> → <strong>Disable</strong>（然后从群组移除 + 重新添加机器人）</li>
                    </ul>
                </li>
                <li><code>openclaw channels status</code> 在配置期望无提及群组消息时显示警告。</li>
            </ul>

            <h3>机器人完全看不到群组消息</h3>
            <ul>
                <li>如果设置了 <code>channels.telegram.groups</code>，群组必须被列出或使用 <code>"*"</code></li>
                <li>检查 @BotFather 中的隐私设置 → "Group Privacy" 应该为 <strong>OFF</strong></li>
                <li>验证机器人确实是成员（不仅仅是无法读取权限的管理员）</li>
            </ul>

            <h3>Node 22+ 上长轮询立即中止</h3>
            <ul>
                <li>Node 22+ 对 <code>AbortSignal</code> 实例更严格；外部信号可以立即中止 <code>fetch</code> 调用。</li>
                <li>升级到规范化中止信号的 OpenClaw 构建，或在可以升级之前在 Node 20 上运行网关。</li>
            </ul>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>OpenClaw = CLAW + TARDIS — 因为每只太空龙虾都需要一台时空机器</p>
            <p>"我们都在玩自己的提示词。" — 某个 AI，大概 token 嗨了</p>
            <p class="license">MIT 协议 — 像海洋中的龙虾一样自由 🦞</p>
        </div>
    </footer>

    <script src="../assets/js/main.js"></script>
</body>
</html>
